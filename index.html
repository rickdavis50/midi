<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pop Parts for Kids</title>
<style>
  :root {
    --bg: #05060a;
    --panel: #0d1326;
    --ink: rgba(255,255,255,0.95);
    --muted: rgba(255,255,255,0.65);
    --beat: 0.5s;
    --groove: 0.08;
    --magic: 0.1;
  }
  * { box-sizing: border-box; }
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000000;
    color: var(--ink);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    overflow: hidden;
  }
  .app {
    min-height: 100%;
    display: grid;
    grid-template-rows: auto 1fr;
    padding: 20px;
    gap: 16px;
  }
  header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .title {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.04em;
  }
  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  button {
    background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
    color: var(--ink);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
  }
  button:hover {
    border-color: rgba(0,229,255,0.6);
    box-shadow: 0 0 14px rgba(0,229,255,0.35);
  }
  button:active { transform: translateY(1px); }
  #panicBtn {
    border-color: rgba(255,45,255,0.4);
    box-shadow: 0 0 12px rgba(255,45,255,0.3);
  }

  .layout {
    display: grid;
    grid-template-columns: minmax(280px, 1fr) minmax(260px, 320px);
    gap: 20px;
    align-items: center;
    max-width: 980px;
    margin: 0 auto;
  }

  .chord-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(110px, 1fr));
    gap: clamp(12px, 2vw, 18px);
  }
  .chord-btn {
    position: relative;
    height: clamp(110px, 16vw, 160px);
    border-radius: 22px;
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)),
                linear-gradient(180deg, #121725, #0a0d17);
    border: 1px solid rgba(0,0,0,0.6);
    box-shadow:
      inset 0 2px 3px rgba(255,255,255,0.08),
      inset 0 -10px 18px rgba(0,0,0,0.7),
      0 0 20px var(--glow),
      0 12px 20px rgba(0,0,0,0.6);
    display: grid;
    place-items: center;
    font-size: 26px;
    font-weight: 700;
    color: rgba(255,255,255,0.95);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    cursor: pointer;
    overflow: hidden;
  }
  .chord-btn::after {
    content: "";
    position: absolute;
    inset: -14px;
    border-radius: 28px;
    background:
      linear-gradient(180deg, rgba(0,0,0,0.8), rgba(0,0,0,0.2)),
      linear-gradient(180deg, var(--glow), rgba(0,0,0,0.2));
    opacity: 1;
    z-index: -1;
  }
  .chord-btn::before {
    content: "";
    position: absolute;
    inset: 10px;
    border-radius: 18px;
    background: linear-gradient(180deg, #0f131d, #0b0f18);
    box-shadow: inset 0 2px 3px rgba(255,255,255,0.06);
  }
  .chord-btn .label {
    position: relative;
    z-index: 1;
  }
  .chord-btn .hint {
    position: absolute;
    bottom: 12px;
    font-size: 12px;
    letter-spacing: 0.12em;
    color: rgba(255,255,255,0.6);
  }
  .chord-btn .pulse-ring {
    position: absolute;
    inset: 14px;
    border-radius: 18px;
    border: 2px solid rgba(255,255,255,0.2);
    opacity: 0;
    transform: scale(0.94);
  }
  .chord-btn.active {
    transform: translateY(3px) scale(0.99);
    box-shadow:
      inset 0 2px 3px rgba(255,255,255,0.08),
      inset 0 -6px 12px rgba(0,0,0,0.7),
      0 0 32px var(--glow),
      0 6px 16px rgba(0,0,0,0.55);
    animation: glowBreath 2.2s ease-in-out infinite;
  }
  .chord-btn.active .pulse-ring {
    opacity: 0.6;
    animation: pulseRing var(--beat) ease-in-out infinite;
  }

  .side-panel {
    background: rgba(13,19,38,0.7);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .microcopy {
    font-size: 12px;
    color: var(--muted);
  }
  .slider-group {
    display: grid;
    gap: 8px;
  }
  .slider-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
  }
  .slider-label {
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .slider-value {
    font-variant-numeric: tabular-nums;
    font-size: 13px;
  }
  input[type="range"] {
    width: 100%;
    accent-color: #00e5ff;
  }
  .indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--muted);
  }
  .tempo-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #00e5ff;
    animation: tempoBounce var(--beat) linear infinite;
  }
  .groove-wobble {
    width: 18px;
    height: 6px;
    border-radius: 999px;
    background: #ff2dff;
    animation: grooveWobble 0.8s ease-in-out infinite;
    transform-origin: center;
  }
  .density-dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    margin-right: 2px;
    border-radius: 50%;
    background: #7CFF4E;
    opacity: 0.2;
    transition: opacity 0.2s ease;
  }
  .density-dots[data-level="1"] span:nth-child(-n+1),
  .density-dots[data-level="2"] span:nth-child(-n+2),
  .density-dots[data-level="3"] span:nth-child(-n+3),
  .density-dots[data-level="4"] span:nth-child(-n+4) {
    opacity: 0.8;
  }
  .magic-shimmer {
    width: 24px;
    height: 10px;
    border-radius: 6px;
    background: linear-gradient(90deg, rgba(255,210,74,0.3), rgba(255,210,74,0.9));
    animation: shimmer 1.4s ease-in-out infinite;
    opacity: calc(0.3 + var(--magic));
  }

  @keyframes pulseRing {
    0% { transform: scale(0.94); opacity: 0.55; }
    50% { transform: scale(1.03); opacity: 0.2; }
    100% { transform: scale(0.94); opacity: 0.55; }
  }
  @keyframes glowBreath {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.75; }
  }
  @keyframes tempoBounce {
    0% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
    100% { transform: translateY(0); }
  }
  @keyframes grooveWobble {
    0% { transform: rotate(-6deg) scaleX(0.9); }
    50% { transform: rotate(6deg) scaleX(1.1); }
    100% { transform: rotate(-6deg) scaleX(0.9); }
  }
  @keyframes shimmer {
    0% { transform: translateX(-2px); opacity: 0.4; }
    50% { transform: translateX(2px); opacity: 0.9; }
    100% { transform: translateX(-2px); opacity: 0.4; }
  }
  @media (prefers-reduced-motion: reduce) {
    .chord-btn.active { animation: none; }
    .chord-btn.active .pulse-ring { animation: none; }
    .tempo-dot, .groove-wobble, .magic-shimmer { animation: none; }
  }
  @media (max-width: 980px) {
    .layout { grid-template-columns: 1fr; }
    .side-panel { width: min(100%, 520px); margin: 0 auto; }
  }
  .chord-grid .chord-btn:nth-child(4n+1) { --glow: #ff1b7a; }
  .chord-grid .chord-btn:nth-child(4n+2) { --glow: #2f3aa8; }
  .chord-grid .chord-btn:nth-child(4n+3) { --glow: #f2ff5a; }
  .chord-grid .chord-btn:nth-child(4n+4) { --glow: #7fb4ff; }
  .particle-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }
  .particle {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--pcolor);
    opacity: 0;
    transform: translate3d(0,0,0) scale(0.6);
    will-change: transform, opacity;
    box-shadow: 0 0 12px var(--pcolor);
  }
  .app {
    position: relative;
    z-index: 1;
  }
</style>
</head>
<body>
  <div class="particle-layer" id="particles"></div>
  <div class="app" id="app">
    <header>
      <div class="title">Pop Parts for Kids</div>
      <div class="controls">
        <button id="unlockBtn">Unlock Audio</button>
        <button id="panicBtn">Panic</button>
      </div>
    </header>

    <div class="layout">
      <div class="chord-grid" id="chordGrid">
        <button class="chord-btn" data-chord="C"><span class="label">C</span><span class="hint">Happy</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="G"><span class="label">G</span><span class="hint">Bright</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="Am"><span class="label">Am</span><span class="hint">Dreamy</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="F"><span class="label">F</span><span class="hint">Warm</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="Dm"><span class="label">Dm</span><span class="hint">Soft</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="Em"><span class="label">Em</span><span class="hint">Cool</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="G/B"><span class="label">G/B</span><span class="hint">Lift</span><span class="pulse-ring"></span></button>
        <button class="chord-btn" data-chord="C/E"><span class="label">C/E</span><span class="hint">Glow</span><span class="pulse-ring"></span></button>
      </div>

      <div class="side-panel">
        <div class="microcopy">? Hold a chord to hear it evolve.</div>

        <div class="slider-group">
          <div class="slider-row">
            <div class="slider-label">Tempo</div>
            <div class="slider-value" id="tempoValue">120</div>
          </div>
          <input id="tempoSlider" type="range" min="80" max="160" value="120" />
          <div class="indicator"><span class="tempo-dot"></span> Speed</div>
        </div>

        <div class="slider-group">
          <div class="slider-row">
            <div class="slider-label">Groove</div>
            <div class="slider-value" id="grooveValue">Bouncy</div>
          </div>
          <input id="grooveSlider" type="range" min="0" max="100" value="60" />
          <div class="indicator"><span class="groove-wobble"></span> Feel</div>
        </div>

        <div class="slider-group">
          <div class="slider-row">
            <div class="slider-label">Density</div>
            <div class="slider-value" id="densityValue">Simple</div>
          </div>
          <input id="densitySlider" type="range" min="0" max="100" value="25" />
          <div class="indicator density-dots" id="densityDots" data-level="1">
            <span></span><span></span><span></span><span></span>
          </div>
        </div>

        <div class="slider-group">
          <div class="slider-row">
            <div class="slider-label">Magic</div>
            <div class="slider-value" id="magicValue">Clean</div>
          </div>
          <input id="magicSlider" type="range" min="0" max="100" value="10" />
          <div class="indicator"><span class="magic-shimmer"></span> Sparkle</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const chordButtons = Array.from(document.querySelectorAll(".chord-btn"));
  const unlockBtn = document.getElementById("unlockBtn");
  const panicBtn = document.getElementById("panicBtn");
  const tempoSlider = document.getElementById("tempoSlider");
  const tempoValue = document.getElementById("tempoValue");
  const grooveSlider = document.getElementById("grooveSlider");
  const grooveValue = document.getElementById("grooveValue");
  const densitySlider = document.getElementById("densitySlider");
  const densityValue = document.getElementById("densityValue");
  const densityDots = document.getElementById("densityDots");
  const magicSlider = document.getElementById("magicSlider");
  const magicValue = document.getElementById("magicValue");
  const app = document.getElementById("app");
  const particlesLayer = document.getElementById("particles");

  let audioCtx = null;
  let masterGain = null;
  let masterBus = null;
  let saturator = null;
  let compressor = null;
  let delaySend = null;
  let delayNode = null;
  let delayFeedback = null;
  let delayFilter = null;
  let noiseBuffer = null;

  let bpm = 120;
  let groove = 0.55;
  let density = 0.25;
  let magic = 0.1;

  let currentChordVoice = null;
  let currentChordName = null;
  let beatRunning = false;
  let schedulerTimer = null;
  let nextStepTime = 0;
  let stepIndex = 0;
  const particles = new Set();
  let particleRaf = null;

  const chordMap = {
    "C": [60, 64, 67, 72],
    "G": [55, 59, 62, 67],
    "Am": [57, 60, 64, 69],
    "F": [53, 57, 60, 65],
    "Dm": [50, 53, 57, 62],
    "Em": [52, 55, 59, 64],
    "G/B": [59, 62, 67, 71],
    "C/E": [52, 55, 60, 64]
  };

  function ensureAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      setupAudioChain();
    }
    if (audioCtx.state === "suspended") {
      audioCtx.resume();
    }
  }

  function setupAudioChain() {
    masterBus = audioCtx.createGain();
    masterBus.gain.value = 1;

    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.65;

    saturator = audioCtx.createWaveShaper();
    saturator.curve = makeSaturationCurve(0.2);
    saturator.oversample = "2x";

    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -18;
    compressor.knee.value = 20;
    compressor.ratio.value = 2.2;
    compressor.attack.value = 0.008;
    compressor.release.value = 0.12;

    delaySend = audioCtx.createGain();
    delaySend.gain.value = 0.08;
    delayNode = audioCtx.createDelay(0.6);
    delayNode.delayTime.value = 0.25;
    delayFeedback = audioCtx.createGain();
    delayFeedback.gain.value = 0.25;
    delayFilter = audioCtx.createBiquadFilter();
    delayFilter.type = "lowpass";
    delayFilter.frequency.value = 2600;

    masterBus.connect(saturator);
    saturator.connect(compressor);
    compressor.connect(masterGain);
    masterGain.connect(audioCtx.destination);

    masterBus.connect(delaySend);
    delaySend.connect(delayNode);
    delayNode.connect(delayFilter);
    delayFilter.connect(compressor);
    delayNode.connect(delayFeedback);
    delayFeedback.connect(delayNode);

    noiseBuffer = createNoiseBuffer();
  }

  function makeSaturationCurve(amount) {
    const samples = 44100;
    const curve = new Float32Array(samples);
    const k = amount * 40;
    for (let i = 0; i < samples; i++) {
      const x = (i * 2) / samples - 1;
      curve[i] = ((1 + k) * x) / (1 + k * Math.abs(x));
    }
    return curve;
  }

  function createNoiseBuffer() {
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 1, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = Math.random() * 2 - 1;
    }
    return buffer;
  }

  function midiToFreq(midi) {
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function updateMagic() {
    const drive = 0.15 + magic * 0.5;
    if (saturator) saturator.curve = makeSaturationCurve(drive);
    if (delaySend) delaySend.gain.value = 0.05 + magic * 0.08;
    app.style.setProperty("--magic", magic.toFixed(2));
  }

  function spawnParticles(x, y, color) {
    const count = 36;
    for (let i = 0; i < count; i++) {
      const el = document.createElement("div");
      el.className = "particle";
      el.style.setProperty("--pcolor", color);
      particlesLayer.appendChild(el);
      const angle = Math.random() * Math.PI * 2;
      const speed = 40 + Math.random() * 180;
      const life = 500 + Math.random() * 600;
      const particle = {
        el,
        start: performance.now(),
        duration: life,
        x,
        y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        spin: (Math.random() - 0.5) * 4
      };
      particles.add(particle);
    }
    if (!particleRaf) {
      particleRaf = requestAnimationFrame(tickParticles);
    }
  }

  function tickParticles(now) {
    particles.forEach((p) => {
      const t = (now - p.start) / p.duration;
      if (t >= 1) {
        p.el.remove();
        particles.delete(p);
        return;
      }
      const driftX = p.vx * t;
      const driftY = p.vy * t + t * t * 40;
      p.el.style.opacity = String(1 - t);
      p.el.style.transform = `translate3d(${p.x + driftX}px, ${p.y + driftY}px, 0) scale(${0.6 + t}) rotate(${p.spin * t}rad)`;
    });
    if (particles.size) {
      particleRaf = requestAnimationFrame(tickParticles);
    } else {
      particleRaf = null;
    }
  }

  function createNoiseBurst(time, duration, gainValue, freq) {
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.value = freq;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(gainValue, time);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + duration);
    noise.connect(filter);
    filter.connect(gain);
    gain.connect(masterBus);
    noise.start(time);
    noise.stop(time + duration + 0.02);
  }

  function createChordVoice(chordName) {
    const now = audioCtx.currentTime;
    const notes = chordMap[chordName] || chordMap.C;
    const voiceGain = audioCtx.createGain();
    voiceGain.gain.setValueAtTime(0.0001, now);
    voiceGain.gain.linearRampToValueAtTime(0.5, now + 0.04);

    const filter = audioCtx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.setValueAtTime(1400, now);
    filter.frequency.linearRampToValueAtTime(2200, now + 1.5);

    const lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.frequency.value = 0.35 + magic * 0.6;
    lfoGain.gain.value = 60 + magic * 120;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);

    const shimmerGain = audioCtx.createGain();
    shimmerGain.gain.setValueAtTime(0.0001, now + 1.5);
    shimmerGain.gain.linearRampToValueAtTime(0.12 + magic * 0.18, now + 3);

    const nodes = notes.map((midi, i) => {
      const osc = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const pan = audioCtx.createStereoPanner();
      const detune = (i % 2 === 0 ? -6 : 6) * (1 + magic * 0.5);
      osc.type = "triangle";
      osc.frequency.value = midiToFreq(midi);
      osc.detune.value = detune;
      osc2.type = "sawtooth";
      osc2.frequency.value = midiToFreq(midi);
      osc2.detune.value = detune * 0.4;
      pan.pan.value = (i - 1.5) * 0.2;
      osc.connect(pan);
      osc2.connect(pan);
      pan.connect(filter);
      osc.start(now + i * 0.012);
      osc2.start(now + i * 0.012);
      return { osc, osc2 };
    });

    const shimmerOsc = audioCtx.createOscillator();
    shimmerOsc.type = "triangle";
    shimmerOsc.frequency.value = midiToFreq(notes[0] + 12);
    shimmerOsc.connect(shimmerGain);
    shimmerGain.connect(filter);
    shimmerOsc.start(now + 1.5);

    filter.connect(voiceGain);
    voiceGain.connect(masterBus);

    createNoiseBurst(now, 0.06, 0.2, 2200);
    lfo.start(now + 1.5);

    return {
      stop(release = 0.16) {
        const t = audioCtx.currentTime;
        voiceGain.gain.cancelScheduledValues(t);
        voiceGain.gain.setValueAtTime(Math.max(voiceGain.gain.value, 0.0001), t);
        voiceGain.gain.exponentialRampToValueAtTime(0.0001, t + release);
        nodes.forEach(({ osc, osc2 }) => {
          osc.stop(t + release + 0.05);
          osc2.stop(t + release + 0.05);
        });
        shimmerOsc.stop(t + release + 0.05);
        lfo.stop(t + release + 0.05);
      }
    };
  }

  function playKick(time) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(120, time);
    osc.frequency.exponentialRampToValueAtTime(40, time + 0.12);
    gain.gain.setValueAtTime(0.9, time);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.16);
    osc.connect(gain);
    gain.connect(masterBus);
    osc.start(time);
    osc.stop(time + 0.18);
    createNoiseBurst(time, 0.02, 0.12, 1800);
  }

  function playSnare(time) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "triangle";
    osc.frequency.setValueAtTime(190, time);
    gain.gain.setValueAtTime(0.2, time);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.18);
    osc.connect(gain);
    gain.connect(masterBus);
    osc.start(time);
    osc.stop(time + 0.2);
    [0, 0.015, 0.03].forEach((offset, i) => {
      createNoiseBurst(time + offset, 0.12, 0.22 - i * 0.04, 1800);
    });
  }

  function playHat(time, length) {
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = "highpass";
    filter.frequency.value = 5200;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.08 + density * 0.08, time);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + length);
    noise.connect(filter);
    filter.connect(gain);
    gain.connect(masterBus);
    noise.start(time);
    noise.stop(time + length + 0.02);
  }

  function scheduleBeat() {
    const scheduleAhead = 0.15;
    const stepDur = (60 / bpm) / 4;
    const swingAmount = groove;

    while (nextStepTime < audioCtx.currentTime + scheduleAhead) {
      const step = stepIndex % 16;
      const beat = step % 4;
      const time = nextStepTime;

      const kickOn1 = density > 0.25;
      if (step === 0 || (kickOn1 && step === 8)) {
        playKick(time);
      }
      if (step === 4 || step === 12) {
        playSnare(time);
      }
      const swingOffset = (step % 2 === 1) ? (swingAmount - 0.5) * stepDur : 0;
      if (step % 2 === 0 || density > 0.35) {
        const hatLen = density > 0.6 ? 0.14 : 0.08;
        playHat(time + swingOffset, hatLen);
      }
      if (density > 0.7 && beat === 3) {
        playHat(time + swingOffset + stepDur * 0.5, 0.05);
      }
      if (density > 0.8 && step === 14) {
        playSnare(time + 0.01);
      }

      nextStepTime += stepDur;
      stepIndex += 1;
    }

    schedulerTimer = setTimeout(scheduleBeat, 25);
  }

  function startBeat() {
    if (beatRunning) return;
    beatRunning = true;
    nextStepTime = audioCtx.currentTime + 0.05;
    stepIndex = 0;
    scheduleBeat();
  }

  function stopBeat() {
    beatRunning = false;
    if (schedulerTimer) clearTimeout(schedulerTimer);
    schedulerTimer = null;
  }

  function stopAll() {
    stopBeat();
    if (currentChordVoice) {
      currentChordVoice.stop(0.08);
      currentChordVoice = null;
    }
    chordButtons.forEach(btn => btn.classList.remove("active"));
  }

  function setActiveChord(button, chordName) {
    if (currentChordName === chordName) return;
    const now = audioCtx.currentTime;
    if (currentChordVoice) {
      currentChordVoice.stop(0.14);
    }
    currentChordVoice = createChordVoice(chordName);
    currentChordName = chordName;
    chordButtons.forEach(btn => btn.classList.toggle("active", btn === button));
  }

  chordButtons.forEach(button => {
    button.addEventListener("pointerdown", (e) => {
      ensureAudio();
      button.setPointerCapture(e.pointerId);
      const color = getComputedStyle(button).getPropertyValue("--glow").trim() || "#ffffff";
      spawnParticles(e.clientX, e.clientY, color);
      setActiveChord(button, button.dataset.chord);
      startBeat();
    });
    button.addEventListener("pointerup", () => {
      if (currentChordVoice) currentChordVoice.stop(0.16);
      currentChordVoice = null;
      currentChordName = null;
      chordButtons.forEach(btn => btn.classList.remove("active"));
    });
    button.addEventListener("pointercancel", () => {
      if (currentChordVoice) currentChordVoice.stop(0.12);
      currentChordVoice = null;
      currentChordName = null;
      chordButtons.forEach(btn => btn.classList.remove("active"));
    });
    button.addEventListener("mouseleave", () => {
      if (currentChordVoice) currentChordVoice.stop(0.16);
      currentChordVoice = null;
      currentChordName = null;
      chordButtons.forEach(btn => btn.classList.remove("active"));
    });
  });

  unlockBtn.addEventListener("click", () => {
    ensureAudio();
    startBeat();
  });

  panicBtn.addEventListener("click", () => {
    stopAll();
  });

  tempoSlider.addEventListener("input", (e) => {
    bpm = Number(e.target.value);
    tempoValue.textContent = String(bpm);
    app.style.setProperty("--beat", `${60 / bpm}s`);
  });

  grooveSlider.addEventListener("input", (e) => {
    const value = Number(e.target.value);
    groove = 0.5 + (value / 100) * 0.12;
    grooveValue.textContent = value < 40 ? "Straight" : value < 70 ? "Bouncy" : "Wiggly";
    app.style.setProperty("--groove", (value / 100).toFixed(2));
  });

  densitySlider.addEventListener("input", (e) => {
    const value = Number(e.target.value);
    density = value / 100;
    densityValue.textContent = value < 40 ? "Simple" : value < 70 ? "Fun" : "Busy";
    densityDots.dataset.level = value < 25 ? "1" : value < 50 ? "2" : value < 75 ? "3" : "4";
  });

  magicSlider.addEventListener("input", (e) => {
    const value = Number(e.target.value);
    magic = value / 100;
    magicValue.textContent = value < 30 ? "Clean" : value < 70 ? "Sparkly" : "Alien";
    updateMagic();
  });

  window.addEventListener("blur", () => {
    stopAll();
  });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopAll();
  });

  tempoValue.textContent = String(bpm);
  app.style.setProperty("--beat", `${60 / bpm}s`);
  updateMagic();
})();
</script>
</body>
</html>
